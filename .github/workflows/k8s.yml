name: k8s-lint
on:
  push:
    branches:
      - master
      - main
  pull_request:

jobs:
  helm-lint:
    name: helm-lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Lint dex chart
        run: helm lint charts/dex

      - name: Lint dex-k8s-authenticator chart
        run: helm lint charts/dex-k8s-authenticator

      - name: Template charts
        run: |
          mkdir -p rendered-charts
          helm template dex charts/dex --output-dir rendered-charts/dex
          helm template dex-k8s-authenticator charts/dex-k8s-authenticator --output-dir rendered-charts/dex-k8s-authenticator

      - name: Validate with kubeconform
        uses: docker://ghcr.io/yannh/kubeconform:latest
        with:
          args: "-summary -strict -ignore-missing-schemas rendered-charts/"

  e2e:
    name: e2e
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Create kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: kind

      - name: Build CI image
        run: |
          docker build -t wowsel/dex-k8s-authenticator:${GITHUB_SHA} .
          kind load docker-image wowsel/dex-k8s-authenticator:${GITHUB_SHA} --name kind

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Prepare helm values
        run: |
          export NODE_IP=$(kubectl get nodes -o jsonpath="{.items[0].status.addresses[0].address}")
          export CI_TAG=$GITHUB_SHA
          envsubst < ./tests/e2e/helm/dex-overrides.yaml > /tmp/dex-overrides.yaml
          envsubst < ./tests/e2e/helm/dex-k8s-auth-overrides.yaml > /tmp/dex-k8s-auth-overrides.yaml

      - name: Install Dex
        run: |
          helm install dex ./charts/dex -f /tmp/dex-overrides.yaml
          kubectl describe deployment dex
          kubectl rollout status deploy dex -w --timeout=120s

      - name: Install dex-k8s-authenticator
        run: |
          helm install dex-k8s-authenticator ./charts/dex-k8s-authenticator -f /tmp/dex-k8s-auth-overrides.yaml
          kubectl describe deployment dex-k8s-authenticator
          kubectl rollout status deploy dex-k8s-authenticator -w --timeout=120s

      - name: Test
        run: |
          kubectl get pods
          export NODE_IP=$(kubectl get nodes -o jsonpath="{.items[0].status.addresses[0].address}")
          echo "Testing endpoint: http://${NODE_IP}:30000/login/my-cluster"
          # Wait for service to be ready and retry up to 30 seconds
          for i in {1..6}; do
            if curl -Lsf "http://${NODE_IP}:30000/login/my-cluster" | grep -q "Log in to Your Account"; then
              echo "Test passed!"
              exit 0
            fi
            echo "Attempt $i failed, waiting 5 seconds..."
            sleep 5
          done
          echo "Test failed after 6 attempts"
          exit 1
