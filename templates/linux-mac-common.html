{{ define "linux-mac-common" }}

  {{ if .UseKubelogin }}
  {{/* ==================== KUBELOGIN MODE ==================== */}}
  
  {{ if or .K8sCaURI .K8sCaPem }}
  <div class="step-header">
    <span class="step-number">1</span>
    <h3>Save Kubernetes CA Certificate</h3>
  </div>
  <p>Download the cluster CA certificate:</p>
  {{ if .K8sCaURI }}
  <div class="command">
    <button class="btn" data-clipboard-snippet="">Copy</button>
    <pre><code>curl --create-dirs -s {{ .K8sCaURI }} -o ${HOME}/.kube/certs/{{ .ClusterName }}/k8s-ca.crt</code></pre>
  </div>
  {{ else if .K8sCaPem }}
  <div class="command">
    <button class="btn" data-clipboard-snippet="">Copy</button>
    <pre><code>mkdir -p ${HOME}/.kube/certs/{{ .ClusterName }}/ &amp;&amp; cat &lt;&lt; 'EOF' &gt; ${HOME}/.kube/certs/{{ .ClusterName }}/k8s-ca.crt
{{ .K8sCaPem }}
EOF</code></pre>
  </div>
  {{ end }}
  {{ end }}

  <div class="step-header">
    <span class="step-number">{{ if or .K8sCaURI .K8sCaPem }}2{{ else }}1{{ end }}</span>
    <h3>Configure Cluster</h3>
  </div>
  <p>Register the Kubernetes cluster:</p>
  <div class="command">
    <button class="btn" data-clipboard-snippet="">Copy</button>
    <pre><code>kubectl config set-cluster {{ .ClusterName }} \
  {{- if or .K8sCaPem .K8sCaURI }}
    --certificate-authority=${HOME}/.kube/certs/{{ .ClusterName }}/k8s-ca.crt \
  {{- end }}
    --server={{ .K8sMasterURI }}</code></pre>
  </div>

  <div class="step-header">
    <span class="step-number">{{ if or .K8sCaURI .K8sCaPem }}3{{ else }}2{{ end }}</span>
    <h3>Configure Credentials with kubelogin</h3>
  </div>
  <p>Set up OIDC authentication using the exec credential plugin:</p>
  <div class="command">
    <button class="btn" data-clipboard-snippet="">Copy</button>
    <pre><code>kubectl config set-credentials {{ .Username }}-{{ .ClusterName }} \
    --exec-api-version=client.authentication.k8s.io/v1beta1 \
    --exec-command=kubectl \
    --exec-arg=oidc-login \
    --exec-arg=get-token \
    --exec-arg=--oidc-issuer-url={{ .Issuer }} \
    --exec-arg=--oidc-client-id={{ .ClientID }}{{ if .ClientSecret }} \
    --exec-arg=--oidc-client-secret={{ .ClientSecret }}{{ end }}</code></pre>
  </div>

  <div class="step-header">
    <span class="step-number">{{ if or .K8sCaURI .K8sCaPem }}4{{ else }}3{{ end }}</span>
    <h3>Set Context and Activate</h3>
  </div>
  <p>Create and switch to the new context:</p>
  <div class="command">
    <button class="btn" data-clipboard-snippet="">Copy</button>
    <pre><code>kubectl config set-context {{ if not .StaticContextName }}{{ .Username }}-{{ end }}{{ .ClusterName }} \
    --cluster={{ .ClusterName }}{{ if .Namespace }} \
    --namespace={{ .Namespace }}{{ end }} \
    --user={{ .Username }}-{{ .ClusterName }}</code></pre>
  </div>

  <div class="command">
    <button class="btn" data-clipboard-snippet="">Copy</button>
    <pre><code>kubectl config use-context {{ if not .StaticContextName }}{{ .Username }}-{{ end }}{{ .ClusterName }}</code></pre>
  </div>

  <div class="step-header">
    <span class="step-number">{{ if or .K8sCaURI .K8sCaPem }}5{{ else }}4{{ end }}</span>
    <h3>Test Connection</h3>
  </div>
  <p>Verify your configuration works (this will open a browser for authentication):</p>
  <div class="command">
    <button class="btn" data-clipboard-snippet="">Copy</button>
    <pre><code>kubectl get namespaces</code></pre>
  </div>

  {{ else }}
  {{/* ==================== LEGACY AUTH-PROVIDER MODE ==================== */}}

  {{ if or .IDPCaURI .IDPCaPem .K8sCaURI .K8sCaPem }}
  <div class="step-header">
    <span class="step-number">1</span>
    <h3>Save CA Certificates</h3>
  </div>
  <p>Download the required certificates:</p>

  {{ if .IDPCaURI }}
  <div class="command">
    <button class="btn" data-clipboard-snippet="">Copy</button>
    <pre><code>curl --create-dirs -s {{ .IDPCaURI }} -o ${HOME}/.kube/certs/{{ .ClusterName }}/idp-ca.crt</code></pre>
  </div>
  {{ end }}

  {{ if .IDPCaPem }}
  <div class="command">
    <button class="btn" data-clipboard-snippet="">Copy</button>
    <pre><code>mkdir -p ${HOME}/.kube/certs/{{ .ClusterName }}/ &amp;&amp; cat &lt;&lt; 'EOF' &gt; ${HOME}/.kube/certs/{{ .ClusterName }}/idp-ca.crt
{{ .IDPCaPem }}
EOF</code></pre>
  </div>
  {{ end }}

  {{ if .K8sCaURI }}
  <div class="command">
    <button class="btn" data-clipboard-snippet="">Copy</button>
    <pre><code>curl --create-dirs -s {{ .K8sCaURI }} -o ${HOME}/.kube/certs/{{ .ClusterName }}/k8s-ca.crt</code></pre>
  </div>
  {{ end }}

  {{ if .K8sCaPem }}
  <div class="command">
    <button class="btn" data-clipboard-snippet="">Copy</button>
    <pre><code>mkdir -p ${HOME}/.kube/certs/{{ .ClusterName }}/ &amp;&amp; cat &lt;&lt; 'EOF' &gt; ${HOME}/.kube/certs/{{ .ClusterName }}/k8s-ca.crt
{{ .K8sCaPem }}
EOF</code></pre>
  </div>
  {{ end }}
  {{ end }}

  <div class="step-header">
    <span class="step-number">{{ if or .IDPCaURI .IDPCaPem .K8sCaURI .K8sCaPem }}2{{ else }}1{{ end }}</span>
    <h3>Configure Cluster</h3>
  </div>
  <p>Register the Kubernetes cluster:</p>
  <div class="command">
    <button class="btn" data-clipboard-snippet="">Copy</button>
    <pre><code>kubectl config set-cluster {{ .ClusterName }} \
  {{- if or .K8sCaPem .K8sCaURI }}
    --certificate-authority=${HOME}/.kube/certs/{{ .ClusterName }}/k8s-ca.crt \
  {{- end }}
    --server={{ .K8sMasterURI }}</code></pre>
  </div>

  <div class="step-header">
    <span class="step-number">{{ if or .IDPCaURI .IDPCaPem .K8sCaURI .K8sCaPem }}3{{ else }}2{{ end }}</span>
    <h3>Configure Credentials</h3>
  </div>
  <p>Set up OIDC authentication:</p>
  <div class="command">
    <button class="btn" data-clipboard-snippet="">Copy</button>
    <pre><code>kubectl config set-credentials {{ .Username }}-{{ .ClusterName }} \
    --auth-provider=oidc \
    --auth-provider-arg="idp-issuer-url={{ .Issuer }}" \
    --auth-provider-arg="client-id={{ .ClientID }}" \
    --auth-provider-arg="client-secret={{ .ClientSecret }}" \
    --auth-provider-arg="refresh-token={{ .RefreshToken }}" \
    --auth-provider-arg="id-token={{ .IDToken }}"
  {{- if or (.IDPCaURI) (.IDPCaPem) }} \
    --auth-provider-arg=idp-certificate-authority=${HOME}/.kube/certs/{{ .ClusterName }}/idp-ca.crt
  {{- end }}</code></pre>
  </div>

  <div class="step-header">
    <span class="step-number">{{ if or .IDPCaURI .IDPCaPem .K8sCaURI .K8sCaPem }}4{{ else }}3{{ end }}</span>
    <h3>Set Context and Activate</h3>
  </div>
  <p>Create and switch to the new context:</p>
  <div class="command">
    <button class="btn" data-clipboard-snippet="">Copy</button>
    <pre><code>kubectl config set-context {{ if not .StaticContextName }}{{ .Username }}-{{ end }}{{ .ClusterName }} \
    --cluster={{ .ClusterName }}{{ if .Namespace }} \
    --namespace={{ .Namespace }}{{ end }} \
    --user={{ .Username }}-{{ .ClusterName }}</code></pre>
  </div>

  <div class="command">
    <button class="btn" data-clipboard-snippet="">Copy</button>
    <pre><code>kubectl config use-context {{ if not .StaticContextName }}{{ .Username }}-{{ end }}{{ .ClusterName }}</code></pre>
  </div>
  {{ end }}

{{ end }}
